"use strict";(()=>{var e={};e.id=146,e.ids=[146],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6011:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>v,requestAsyncStorage:()=>y,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var i={};t.r(i),t.d(i,{GET:()=>c,POST:()=>p});var s=t(9303),n=t(8716),a=t(670),o=t(7070),d=t(3493),l=t(971),u=t(9178);async function p(e){try{let r=await e.json(),t=l.Uh.parse(r),i=await d._.checkoutLink.findUnique({where:{id:t.checkoutLinkId},include:{seller:!0}});if(!i)return o.NextResponse.json({error:"Checkout link not found"},{status:404});let s=i.price*t.quantity,n=JSON.stringify(t.buyer),a=null;t.saveDetails&&(a=(await d._.customer.upsert({where:{sellerId_phone:{sellerId:i.sellerId,phone:t.buyer.phone}},update:{fullName:t.buyer.fullName,city:t.buyer.city,address:t.buyer.address,username:t.buyer.username,marketingOptIn:!0,lastUsedAt:new Date},create:{sellerId:i.sellerId,fullName:t.buyer.fullName,phone:t.buyer.phone,city:t.buyer.city,address:t.buyer.address,username:t.buyer.username,marketingOptIn:!0,lastUsedAt:new Date}})).id);let u=await d._.order.create({data:{sellerId:i.sellerId,checkoutLinkId:t.checkoutLinkId,customerId:a,quantity:t.quantity,totalPrice:s,selectedSize:t.selectedSize,contactSnapshot:n,deliveryMethod:t.deliveryMethod},include:{checkoutLink:!0,seller:{select:{id:!0,name:!0,slug:!0,instagramUrl:!0}}}});return o.NextResponse.json(u,{status:201})}catch(e){if("ZodError"===e.name)return o.NextResponse.json({error:"Validation error",details:e.errors},{status:400});return console.error("Error creating order:",e),o.NextResponse.json({error:"Failed to create order"},{status:500})}}async function c(e){try{let r=(0,u.G)(e);if(!r)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:t}=new URL(e.url),i=parseInt(t.get("page")||"1"),s=parseInt(t.get("limit")||"20"),n=(i-1)*s,[a,l]=await Promise.all([d._.order.findMany({where:{sellerId:r},include:{checkoutLink:{select:{id:!0,name:!0}},customer:{select:{id:!0,fullName:!0,phone:!0}}},orderBy:{createdAt:"desc"},skip:n,take:s}),d._.order.count({where:{sellerId:r}})]),p=a.map(e=>({...e,contactSnapshot:JSON.parse(e.contactSnapshot)}));return o.NextResponse.json({orders:p,pagination:{page:i,limit:s,total:l,totalPages:Math.ceil(l/s)}})}catch(e){return console.error("Error fetching orders:",e),o.NextResponse.json({error:"Failed to fetch orders"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/orders/route",pathname:"/api/orders",filename:"route",bundlePath:"app/api/orders/route"},resolvedPagePath:"/Users/otabek/Downloads/Design/Vibe/Cursor/Bog'la for SME's/app/api/orders/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:y,staticGenerationAsyncStorage:h,serverHooks:f}=m,g="/api/orders/route";function v(){return(0,a.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},9178:(e,r,t)=>{t.d(r,{G:()=>i});function i(e){return e.headers.get("X-Seller-ID")}},3493:(e,r,t)=>{t.d(r,{_:()=>s});let i=require("@prisma/client"),s=globalThis.prisma??new i.PrismaClient},971:(e,r,t)=>{t.d(r,{Uh:()=>n,d$:()=>s});var i=t(1067);let s=i.Ry({name:i.Z_().min(1,"Product name is required"),price:i.Rx().int().positive("Price must be positive"),currency:i.Z_().default("UZS"),defaultQty:i.Rx().int().positive().default(1),maxQty:i.Rx().int().positive().optional().nullable(),imageUrl:i.G0([i.Z_().url("Must be a valid URL"),i.i0("")]).optional(),sizes:i.IX(i.Z_().min(1,"Size cannot be empty")).min(1,"At least one size is required"),deliveryOptions:i.Ry({courierCity:i.O7().optional(),pickup:i.O7().optional(),region:i.O7().optional()}).refine(e=>e.courierCity||e.pickup||e.region,{message:"At least one delivery option must be selected"}),paymentNote:i.Z_().min(1,"Payment instructions are required")}),n=i.Ry({checkoutLinkId:i.Z_().min(1),quantity:i.Rx().int().positive("Quantity must be positive"),selectedSize:i.Z_().min(1,"Size selection is required"),deliveryMethod:i.Z_().min(1,"Delivery method is required"),buyer:i.Ry({fullName:i.Z_().min(1,"Full name is required"),phone:i.Z_().regex(/^\+998\d{9}$/,"Invalid Uzbek phone number format"),city:i.Z_().min(1,"City is required"),address:i.Z_().min(1,"Address is required"),username:i.Z_().optional()}),saveDetails:i.O7().default(!1)});i.Ry({paymentStatus:i.Km(["new","paid","cancelled"]).optional(),deliveryStatus:i.Km(["pending","sent","delivered"]).optional()}),i.Ry({email:i.Z_().email("Invalid email address"),password:i.Z_().min(1,"Password is required")})}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[276,972,67],()=>t(6011));module.exports=i})();